---
import BaseLayout from "../../layouts/BaseLayout.astro";
import LogCard from "../../components/LogCard.astro";
import ReviewCard from "../../components/ReviewCard.astro";
import { getCollection } from "astro:content";

// Get all logs and reviews
const allLogs = await getCollection("logs");
const allReviews = await getCollection("reviews");

// Combine and sort by date (newest first)
const allEntries = [
  ...allLogs.map((log) => ({ type: "log", entry: log })),
  ...allReviews.map((review) => ({ type: "review", entry: review })),
].sort((a, b) => b.entry.data.date.valueOf() - a.entry.data.date.valueOf());

// Group by quarter, phase, and week
const groupedEntries = allEntries.reduce(
  (acc, item) => {
    const quarter = item.entry.data.quarter;
    const phase =
      item.entry.data.phase || getPhaseFromWeek(item.entry.data.week);
    const week = item.entry.data.week;
    const key = `Q${quarter}-P${phase}-W${week}`;

    if (!acc[key]) {
      acc[key] = {
        quarter,
        phase,
        week,
        entries: [],
      };
    }
    acc[key].entries.push(item);
    return acc;
  },
  {} as Record<
    string,
    { quarter: number; phase: number; week: number; entries: typeof allEntries }
  >
);

const sortedGroups = Object.values(groupedEntries).sort((a, b) => {
  if (a.quarter !== b.quarter) return b.quarter - a.quarter;
  if (a.phase !== b.phase) return b.phase - a.phase;
  return a.week - b.week;
});

// Helper function to determine phase from week
function getPhaseFromWeek(week: number): number {
  if (week >= 9) return 1; // Phase 1: Weeks 12-9
  if (week >= 5) return 2; // Phase 2: Weeks 8-5
  return 3; // Phase 3: Weeks 4-1
}

function getPhaseName(phase: number): string {
  const names = {
    1: "Foundation",
    2: "Execution",
    3: "Mastery",
  };
  return names[phase as keyof typeof names] || `Phase ${phase}`;
}
---

<BaseLayout
  title="Timeline - All Logs & Reviews"
  description="Complete timeline of all daily logs and weekly reviews from my bug bounty journey"
>
  <div class="container-custom py-12">
    <!-- Header -->
    <div class="mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">
        Complete <span class="text-gradient">Timeline</span>
      </h1>
      <p class="text-xl text-slate-300">
        Every daily log and weekly review organized by quarter, phase, and week.
      </p>
    </div>

    <!-- Stats Bar -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-12">
      <div class="card text-center py-4">
        <div class="text-2xl font-bold text-soft-indigo">{allLogs.length}</div>
        <div class="text-sm text-slate-400">Daily Logs</div>
      </div>
      <div class="card text-center py-4">
        <div class="text-2xl font-bold text-sage">{allReviews.length}</div>
        <div class="text-sm text-slate-400">Weekly Reviews</div>
      </div>
      <div class="card text-center py-4">
        <div class="text-2xl font-bold text-soft-indigo">
          {sortedGroups.length}
        </div>
        <div class="text-sm text-slate-400">Weeks Tracked</div>
      </div>
      <div class="card text-center py-4">
        <div class="text-2xl font-bold text-sage">
          {
            allLogs.length > 0
              ? (
                  allLogs.reduce((sum, l) => sum + (l.data.daily_total || 0), 0) /
                  allLogs.length / 60
                ).toFixed(1)
              : 0
          }
        </div>
        <div class="text-sm text-slate-400">Avg Hours/Day</div>
      </div>
    </div>

    <!-- Timeline -->
    {
      sortedGroups.length > 0 ? (
        <div class="space-y-12">
          {sortedGroups.map((group) => (
            <section>
              <div class="flex items-center mb-6">
                <div class="flex-shrink-0">
                  <div class="inline-flex flex-col sm:flex-row gap-2">
                    <div class="px-4 py-2 bg-gradient-to-r from-soft-indigo to-sage rounded-lg">
                      <div class="text-sm font-bold text-white">
                        Q{group.quarter} - Week {group.week}
                      </div>
                    </div>
                    <div class="px-4 py-2 bg-charcoal border border-sage/30 rounded-lg">
                      <div class="text-sm font-semibold text-sage">
                        Phase {group.phase}: {getPhaseName(group.phase)}
                      </div>
                    </div>
                  </div>
                </div>
                <div class="flex-1 h-px bg-slate-700 ml-4" />
              </div>

              <div class="space-y-6 ml-0 md:ml-36">
                {group.entries.map((item) => {
                  if (item.type === "log") {
                    const log = item.entry as (typeof allLogs)[0];
                    return (
                      <LogCard
                        title={log.data.title}
                        date={log.data.date}
                        slug={log.slug}
                        quarter={log.data.quarter}
                        week={log.data.week}
                        tags={log.data.tags}
                        hunting={log.data.daily_hacking}
                        total={log.data.daily_total}
                        excerpt={log.data.description}
                      />
                    );
                  } else {
                    const review = item.entry as (typeof allReviews)[0];
                    return (
                      <ReviewCard
                        title={review.data.title}
                        date={review.data.date}
                        slug={review.slug}
                        quarter={review.data.quarter}
                        week={review.data.week}
                        weekProgress={review.data.weekProgress}
                        wins={review.data.wins}
                        challenges={review.data.challenges}
                        hunting={review.data.weekly_hacking}
                        total={review.data.weekly_total}
                      />
                    );
                  }
                })}
              </div>
            </section>
          ))}
        </div>
      ) : (
        <div class="card text-center py-16">
          <p class="text-slate-400 text-lg">
            No entries yet. Start documenting your journey!
          </p>
        </div>
      )
    }
  </div>
</BaseLayout>
